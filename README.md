[![Build Status](https://travis-ci.org/Neutrinet/accounting.svg?branch=master)](https://travis-ci.org/Neutrinet/accounting)

# README

- [Setup locally](#setup-locally) (2 options):
  - [Setup locally by installing Ruby and Postgres](#setup-locally-by-installing-ruby-and-postgres)
  - [Setup locally with Docker](#setup-locally-with-docker)
- [Detect new types of transactions](#detect-new-types-of-transactions)

## Setup Locally

### Setup locally by Installing Ruby and Postgres

#### Needed packages

- `$ sudo apt-get install git autoconf bison build-essential libssl-dev libyaml-dev libreadline-dev zlib1g-dev libncurses5-dev libffi-dev libgdbm-dev nodejs`

#### Install Ruby

- install `rbenv`: `sudo apt-get install rbenv`
- install `ruby-build`: [follow those instructions](https://github.com/rbenv/ruby-build#installation) (install "As an rbenv plugin")
  ```
  $ eval "$(rbenv init -)"
  $ git clone https://github.com/rbenv/ruby-build.git "$(rbenv root)"/plugins/ruby-build
  ```
- install Ruby: `$ rbenv install 3.1.3`
- set the default version for Ruby: `$ rbenv global 3.1.3`
- test it worked: `$ ruby -v`
- install Bundler: `$ gem install bundler`

#### Install Postgres

- `$ sudo apt-get install postgresql libpq-dev`
- change default user's password:

```
$ sudo -u postgres psql postgres
# alter user postgres with password 'postgres';
# \q
```

#### Setup

- clone the app: `git clone https://gitlab.domainepublic.net/Neutrinet/accounting.git && cd accounting` 
- install gems: `bundle install`
- make sure there's a `.env` file with those values:
  ```
  ADMIN_PASSWORD=foo
  SECRET_KEY_BASE=<a value generated by `bin/rails secret`>
  DATABASE_URL=postgres://postgres:postgres@localhost:5432/neutrinet_accounting_production
  ```
- run the setup script: `RAILS_ENV=production bin/setup`

#### Run the tests
 
- in the project folder: `bin/cibuild`

#### Run the app locally

- `$ RAILS_ENV=production bundle exec rails s`
- visit http://localhost:3000
- the admin is available at: http://localhost:3000/admin
- the login is `admin` and the password can be found in the `.env` file found at the root of the application directory

### Setup locally with Docker

- TODO

## Detect new types of transactions

If a new recurring type of transaction shows up and you want the app to automatically detect it, follow those steps:
- in [specs/fixtures/movements](specs/fixtures/movements), add a new file prefixed with `ing`, e.g: `ing_my_new_transaction.csv`
- the first line in this file should contain the header of the CSV file, you can take one from [specs/fixtures/movements/ing_gandi.csv](specs/fixtures/movements/ing_gandi.csv)
- the second line should be an example of the transaction you want to automatically detect (don't forget to anonymize the line, e.g: name, bank account, ...)
- in [specs/models/movement_row_spec.rb](specs/models/movement_row_spec.rb), find the `example spec`, duplicate it and replace the values with what you expect to find from the CSV line
- run the specs (see above), they should fail
- add a method in [app/models/movement_identifier.rb](app/models/movement_identifier.rb) to detect your new transaction type. Run the tests, they should all pass.

## Documentation

Here's how to use the tool (french):
https://wiki.neutrinet.be/fr/administration/accounting-tool
